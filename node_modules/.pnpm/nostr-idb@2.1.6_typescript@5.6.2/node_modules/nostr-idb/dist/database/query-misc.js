export async function getEventsFromAddressPointers(db, pointers) {
    const trans = db.transaction("events", "readonly");
    const objectStore = trans.objectStore("events");
    const events = {};
    const promises = pointers.map(async (pointer) => {
        const key = `${pointer.kind}:${pointer.pubkey}:${pointer.identifier ?? ""}`;
        const row = await objectStore.get(key);
        if (row) {
            const existing = events[key];
            if (!existing || row.event.created_at > existing.created_at)
                events[key] = row.event;
        }
    });
    trans.commit();
    const sorted = await Promise.all(promises).then(() => Object.values(events).sort((a, b) => b.created_at - a.created_at));
    return sorted;
}
export async function countEventsByPubkeys(db) {
    let cursor = await db
        .transaction("events", "readonly")
        .objectStore("events")
        .index("pubkey")
        .openKeyCursor();
    if (!cursor)
        return {};
    const counts = {};
    while (cursor) {
        const pubkey = cursor.key;
        counts[pubkey] = (counts[pubkey] || 0) + 1;
        cursor = await cursor.continue();
    }
    return counts;
}
export async function countEventsByKind(db) {
    let cursor = await db
        .transaction("events", "readonly")
        .objectStore("events")
        .index("kind")
        .openKeyCursor();
    if (!cursor)
        return {};
    const counts = {};
    while (cursor) {
        const kind = cursor.key;
        counts[kind] = (counts[kind] || 0) + 1;
        cursor = await cursor.continue();
    }
    return counts;
}
export function countEvents(db) {
    return db.transaction("events", "readonly").store.count();
}
